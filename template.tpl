___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Pub/Sub Publish",
  "brand": {
    "id": "github.com_stape-io",
    "displayName": "stape-io",
    "thumbnail": "data:image/png;base64,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\u003d\u003d"
  },
  "description": "Use this tag for publishing messages to GCP Pub/Sub",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "project",
    "displayName": "Project",
    "simpleValueType": true,
    "help": "GCP project id"
  },
  {
    "type": "TEXT",
    "name": "topic",
    "displayName": "Topic",
    "simpleValueType": true,
    "help": "Pub/Sub topic name"
  },
  {
    "type": "CHECKBOX",
    "name": "addEventData",
    "checkboxText": "Add Event Data",
    "simpleValueType": true,
    "help": "Add all Event Data to the message. If Event Data and Custom Data have the same field, the Custom Data value will be used for that field. In other words, you can override Event Data values with Custom Data."
  },
  {
    "type": "CHECKBOX",
    "name": "addTimestamp",
    "checkboxText": "Add Timestamp",
    "simpleValueType": true,
    "help": "This option will add the millisecond timestamp to the message"
  },
  {
    "type": "CHECKBOX",
    "name": "skipNilValues",
    "checkboxText": "Skip null or undefined values",
    "simpleValueType": true,
    "help": "This option allows skipping items from customDataList and attributesDataList with undefined or null values."
  },
  {
    "type": "TEXT",
    "name": "timestampFieldName",
    "displayName": "Timestamp field name",
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "addTimestamp",
        "paramValue": true,
        "type": "EQUALS"
      }
    ],
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      },
      {
        "type": "REGEX",
        "args": [
          "^[A-Za-z0-9_]*$"
        ],
        "errorMessage": "Letters, numbers and underscores are allowed"
      }
    ],
    "defaultValue": "timestamp"
  },
  {
    "displayName": "Custom Data",
    "name": "customDataListGroup",
    "groupStyle": "ZIPPY_OPEN",
    "type": "GROUP",
    "subParams": [
      {
        "name": "customDataList",
        "simpleTableColumns": [
          {
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "defaultValue": "",
            "displayName": "Field Name",
            "name": "name",
            "isUnique": true,
            "type": "TEXT"
          },
          {
            "defaultValue": "",
            "displayName": "Field Value",
            "name": "value",
            "type": "TEXT"
          }
        ],
        "type": "SIMPLE_TABLE",
        "newRowButtonText": "Add property"
      }
    ]
  },
  {
    "displayName": "Attributes",
    "name": "attributesDataListGroup",
    "groupStyle": "ZIPPY_OPEN",
    "type": "GROUP",
    "subParams": [
      {
        "name": "attributesDataList",
        "simpleTableColumns": [
          {
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "defaultValue": "",
            "displayName": "Field Name",
            "name": "name",
            "isUnique": true,
            "type": "TEXT"
          },
          {
            "defaultValue": "",
            "displayName": "Field Value",
            "name": "value",
            "type": "TEXT"
          }
        ],
        "type": "SIMPLE_TABLE",
        "newRowButtonText": "Add property"
      }
    ],
    "help": "Optional. Attributes for this message. This can be used to filter messages on the subscription."
  },
  {
    "displayName": "Logs Settings",
    "name": "logsGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "type": "RADIO",
        "name": "logType",
        "radioItems": [
          {
            "value": "no",
            "displayValue": "Do not log"
          },
          {
            "value": "debug",
            "displayValue": "Log to console during debug and preview"
          },
          {
            "value": "always",
            "displayValue": "Always log to console"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "debug"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

const JSON = require('JSON');
const getRequestHeader = require('getRequestHeader');
const getAllEventData = require('getAllEventData');
const getTimestampMillis = require('getTimestampMillis');
const logToConsole = require('logToConsole');
const getContainerVersion = require('getContainerVersion');
const getType = require('getType');
const sendHttpRequest = require('sendHttpRequest');
const encodeUriComponent = require('encodeUriComponent');
const getGoogleAuth = require('getGoogleAuth');
const toBase64 = require('toBase64');

const isLoggingEnabled = determinateIsLoggingEnabled();
const traceId = isLoggingEnabled ? getRequestHeader('trace-id') : undefined;

let publishUrl = 'https://pubsub.googleapis.com/v1/projects/'+enc(data.project)+'/topics/'+enc(data.topic)+':publish';
let method = 'POST';
let input = data.addEventData ? getAllEventData() : {};
let attributes = {};

if (data.addTimestamp) input[data.timestampFieldName] = getTimestampMillis();
if (data.customDataList) {
    data.customDataList.forEach((d) => {
        if (data.skipNilValues) {
            const dType = getType(d.value);
            if (dType === 'undefined' || dType === 'null') return;
        }
        if (getType(d.name) === 'string' && d.name.indexOf('.') !== -1) {
            const nameParts = d.name.split('.');
            let obj = input;
            for (let i = 0; i < nameParts.length - 1; i++) {
                const part = nameParts[i];
                if (!obj[part]) {
                    obj[part] = {};
                }
                obj = obj[part];
            }
            obj[nameParts[nameParts.length - 1]] = d.value;
        } else {
            input[d.name] = d.value;
        }
    });
}

if (data.attributesDataList) {
    data.attributesDataList.forEach((d) => {
        if (data.skipNilValues) {
            const dType = getType(d.value);
            if (dType === 'undefined' || dType === 'null') return;
        } else {
            attributes[d.name] = d.value;
        }
    });
}


// Only send `data` and `attributes` keys if their inputs are not empty objects
let message = {};

if (input && JSON.stringify(input) !== '{}') {
    message.data = toBase64(JSON.stringify(input));
}

if (attributes && JSON.stringify(attributes) !== '{}') {
    message.attributes = attributes;
}

input = { messages: [message] };



if (isLoggingEnabled) {
    logToConsole(
      JSON.stringify({
          Name: 'PubSub',
          Type: 'Request',
          TraceId: traceId,
          EventName: 'Publish',
          RequestMethod: method,
          RequestUrl: publishUrl,
          RequestBody: input,
      })
    );
}

const auth = getGoogleAuth({
  scopes: ['https://www.googleapis.com/auth/pubsub']
});

sendHttpRequest(publishUrl, {method: method, headers: { 'Content-Type': 'application/json' }, authorization: auth}, JSON.stringify(input))
  .then(() => {
      if (isLoggingEnabled) {
          logToConsole(
            JSON.stringify({
                Name: 'PubSub',
                Type: 'Response',
                TraceId: traceId,
                EventName: 'Publish',
                ResponseStatusCode: 200,
                ResponseHeaders: {},
                ResponseBody: {},
            })
          );
      }

      data.gtmOnSuccess();
  }, function () {
      if (isLoggingEnabled) {
          logToConsole(
            JSON.stringify({
                Name: 'PubSub',
                Type: 'Response',
                TraceId: traceId,
                EventName: 'Publish',
                ResponseStatusCode: 500,
                ResponseHeaders: {},
                ResponseBody: {},
            })
          );
      }

      data.gtmOnFailure();
  });

function enc(data) {
    data = data || '';
    return encodeUriComponent(data);
}

function determinateIsLoggingEnabled() {
    const containerVersion = getContainerVersion();
    const isDebug = !!(containerVersion && (containerVersion.debugMode || containerVersion.previewMode));

    if (!data.logType) {
        return isDebug;
    }

    if (data.logType === 'no') {
        return false;
    }

    if (data.logType === 'debug') {
        return isDebug;
    }

    return data.logType === 'always';
}


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "read_request",
        "versionId": "1"
      },
      "param": [
        {
          "key": "headerWhitelist",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "trace-id"
                  }
                ]
              }
            ]
          }
        },
        {
          "key": "headersAllowed",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "requestAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "headerAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "queryParameterAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_container_data",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "use_google_credentials",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedScopes",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://www.googleapis.com/auth/pubsub"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 23/04/2022, 12:40:30


